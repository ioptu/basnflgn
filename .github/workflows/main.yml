name: baslgn

on:
  #schedule:
    #- cron: '56 19-23 * * *'
    #- cron: '56 0-13 * * *'
    #- cron: '07 0 * * *'
    
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

  #repository_dispatch: #å…è®¸å¤–éƒ¨è§¦å‘
  #  types: [bascron]
  

jobs:
  run_bas_startup:
    runs-on: ubuntu-latest
    
    # --- å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€ä¸ªè´¦å·åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è·‘ ---
    # å¦‚æœä¸Šä¸€æ¬¡è¿è¡Œè¿˜åœ¨é‡è¯•ï¼Œè€Œæ–°çš„ä¸€æ¬¡è¿è¡Œå¼€å§‹äº†ï¼Œå®ƒä¼šå–æ¶ˆï¼ˆCancelï¼‰æ—§çš„ï¼Œå¼€å¯æ–°çš„ã€‚
    concurrency:
      group: bas-lock-${{ matrix.account.name }}
      cancel-in-progress: true

    permissions:
      actions: write
      contents: read
      
    # Job çº§åˆ«è¶…æ—¶
    timeout-minutes: 60 

    strategy:
      fail-fast: false 
      matrix:
      #  account: [
      #    { name: "Account_1", url_secret: "BAS_URL_1", user_secret: "BAS_USERNAME_1", pass_secret: "BAS_PASSWORD_1" },
      #    { name: "Account_2", url_secret: "BAS_URL_2", user_secret: "BAS_USERNAME_2", pass_secret: "BAS_PASSWORD_2" }
      #  ]
        account: [{ name: "Account_1", url_secret: "BAS_URL_1", user_secret: "BAS_USERNAME_1", pass_secret: "BAS_PASSWORD_1" }]

    name: Run for ${{ matrix.account.name }}
    env:
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  
        uses: actions/checkout@v5

      - name: ğŸ› ï¸ è®¾ç½® Node.js ç¯å¢ƒ 
        uses: actions/setup-node@v6
        with:
          node-version: '24' 

      - name: âš™ï¸ å®‰è£… Puppeteer ä¾èµ–
        run: npm install

      - name: ğŸ’» è¿è¡Œ BAS å¯åŠ¨è„šæœ¬ (å¤±è´¥åç­‰ 0.3 åˆ†é’Ÿé‡è¯•)
        # ä½¿ç”¨ retry æ’ä»¶å®ç°å¾ªç¯é€»è¾‘
        uses: nick-fields/retry@v3
        with:
          # å•æ¬¡è„šæœ¬æœ€å¤§æ‰§è¡Œæ—¶é—´
          timeout_minutes: 15
          # åŒ…å«é¦–æ¬¡è¿è¡Œåœ¨å†…çš„æœ€å¤§å°è¯•æ¬¡æ•°
          max_attempts: 3
          # å¤±è´¥åç­‰å¾…çš„æ—¶é—´ ç§’
          retry_wait_seconds: 20
          # è¦æ‰§è¡Œçš„å‘½ä»¤
          command: node ka.js
        env:
          BAS_URL: ${{ secrets[matrix.account.url_secret] }}
          BAS_USERNAME: ${{ secrets[matrix.account.user_secret] }}
          BAS_PASSWORD: ${{ secrets[matrix.account.pass_secret] }}

      - name: ğŸ—‘ï¸ æ¸…ç†æ—§çš„è¿è¡Œè®°å½•
        # ä»…ç”±ç¬¬ä¸€ä¸ª Job å®ä¾‹æ‰§è¡Œï¼Œé¿å… Account 1 å’Œ 2 åŒæ—¶æ“ä½œ API å¯¼è‡´å†²çª
        if: always() && strategy.job-index == 0
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 3600  

  keepalive-workflow:
    name: Keepalive Workflow
    # ç¡®ä¿ Workflow å§‹ç»ˆå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œä¸ä¼šè¢« GitHub è‡ªåŠ¨åœæ‰
    if: always()
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: liskin/gh-workflow-keepalive@v1
